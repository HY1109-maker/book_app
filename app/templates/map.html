{% extends "base.html" %}

{% block content %}
    <div id="search-box-container">
        <input type="text" id="searchInput" value="カフェ" placeholder="場所やジャンルを検索...">
        <button onclick="searchMap()">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <div class="map-filter">
            <input type="checkbox" id="posts-only-filter">
            <label for="posts-only-filter">投稿があるお店のみ</label>
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>
{% endblock %}

{% block head_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const map = L.map('map').setView([35.0116, 135.7681], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    const postsOnlyFilter = document.getElementById('posts-only-filter');
    const searchInput = document.getElementById('searchInput');

    // --- レイヤー定義 ---
    const ourShopsLayer = L.geoJSON(null, { pointToLayer: createOurShopMarker }).addTo(map);
    const osmShopsLayer = L.geoJSON().addTo(map);

    // --- 関数定義 ---
    function createOurShopMarker(feature, latlng) {
        const icon = L.AwesomeMarkers.icon({
            icon: 'camera', markerColor: 'blue', prefix: 'fa'
        });
        return L.marker(latlng, { icon: icon });
    }

    function openShopPopup(layer) {
        const props = layer.feature.properties;
        const latlng = layer.getLatLng();

        fetch(`/api/shops/${props.id}/posts`)
            .then(response => response.json())
            .then(posts => {
                let imagesHtml = posts.length > 0
                    ? posts.slice(0, 5).map(p => `<img src="/static/uploads/${p.image_filename}" class="popup-scroll-image">`).join('')
                    : '<p>No images yet.</p>';

                const bookmarkClass = props.is_bookmarked ? 'bookmarked' : '';
                const bookmarkText = props.is_bookmarked ? 'Saved' : 'Save';

                const popupContent = `
                    <div class="custom-popup">
                        <div class="popup-header">
                            <h3>${props.name}</h3>
                            <button class="bookmark-btn ${bookmarkClass}" data-shop-id="${props.id}">
                                <i class="fa-solid fa-bookmark"></i> ${bookmarkText}
                            </button>
                        </div>
                        <div class="popup-image-scroller">${imagesHtml}</div>
                        <a href="/shop/${props.id}" class="popup-details-link">View all posts</a>
                    </div>
                `;
                layer.bindPopup(popupContent, { minWidth: 280, autoPanPaddingTopLeft: L.point(0, 70) }).openPopup();
            });
    }

    function applyMapFilter() {
        if (postsOnlyFilter.checked) {
            map.removeLayer(osmShopsLayer);
        } else {
            map.addLayer(osmShopsLayer);
        }
    }

    // --- メインの検索・描画関数 ---
    window.searchMap = function() {
        ourShopsLayer.clearLayers();
        osmShopsLayer.clearLayers();
        const bounds = map.getBounds();
        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
        const keyword = searchInput.value;
        const ourShopOsmIds = new Set();

        fetch('/api/shops')
            .then(res => res.json())
            .then(data => {
                data.features.forEach(f => { if(f.properties.osm_id) ourShopOsmIds.add(f.properties.osm_id) });
                ourShopsLayer.addData(data);
            })
            .then(() => {
                fetch(`/api/osm_search?keyword=${keyword}&bbox=${bbox}`)
                    .then(res => res.json())
                    .then(data => {
                        const filtered = data.features.filter(f => f.properties.osm_id && !ourShopOsmIds.has(f.properties.osm_id));
                        osmShopsLayer.addData({ type: "FeatureCollection", features: filtered });
                        applyMapFilter(); // 検索完了後にフィルターを適用
                    });
            });
    }

    // --- イベントリスナー ---
    ourShopsLayer.on('click', e => openShopPopup(e.layer));

    osmShopsLayer.on('click', e => {
        const props = e.layer.feature.properties;
        const shopName = props.name || '名前不明';
        const link = `<a href="/create_post?shop_name=${encodeURIComponent(shopName)}&osm_id=${props.osm_id}&lat=${e.latlng.lat}&lon=${e.latlng.lng}">Be the first to post!</a>`;
        e.layer.bindPopup(`<b>${shopName}</b><br>No posts yet. ${link}`).openPopup();
    });

    // ★★★ ブックマークのクリック処理を「イベント委譲」で実装 ★★★
    map.getContainer().addEventListener('click', function(event) {
        const bookmarkBtn = event.target.closest('.bookmark-btn');
        if (!bookmarkBtn) return;

        const shopId = bookmarkBtn.dataset.shopId;
        
        // ourShopsLayerから該当するマーカーを探す
        let targetLayer = null;
        ourShopsLayer.eachLayer(layer => {
            if (layer.feature.properties.id == shopId) {
                targetLayer = layer;
            }
        });

        if (!targetLayer) return;

        const isBookmarked = targetLayer.feature.properties.is_bookmarked;
        const apiUrl = isBookmarked ? `/unbookmark/${shopId}` : `/bookmark/${shopId}`;

        fetch(apiUrl, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    // フロントエンドの記憶を更新
                    targetLayer.feature.properties.is_bookmarked = !isBookmarked;
                    // ボタンの見た目を更新
                    bookmarkBtn.classList.toggle('bookmarked');
                    bookmarkBtn.innerHTML = !isBookmarked ? '<i class="fa-solid fa-bookmark"></i> Saved' : '<i class="fa-solid fa-bookmark"></i> Save';
                }
            });
    });

    postsOnlyFilter.addEventListener('change', applyMapFilter);
    searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') searchMap(); });
    
    // --- 初期表示 ---
    searchMap();
    map.on('moveend', searchMap);
});
</script>
{% endblock %}