{% extends "base.html" %}

{% block content %}
    <div id="map-container">
        <div id="map"></div>
        <div id="search-box-container">
            <input type="text" id="searchInput" value="カフェ" placeholder="場所やジャンルを検索...">
            <button onclick="searchMap()">地図を検索</button>
        </div>
        <div id="shop-details-container">
             <p class="placeholder-text">お店のピンをクリックすると投稿が表示されます</p>
        </div>
    </div>
{% endblock %}

{% block head_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([35.0116, 135.7681], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                // ... attribution ...
            }).addTo(map);

            const detailsContainer = document.getElementById('shop-details-container');
            let ourShopsLayer = L.geoJSON(null, { pointToLayer: createOurShopMarker }).addTo(map);
            let osmShopsLayer = L.geoJSON().addTo(map);

            // --- 関数定義 ---
            function createOurShopMarker(feature, latlng) {
                // 自前データ用のカスタムマーカー (例: 色を変える)
                return L.marker(latlng, { icon: L.divIcon({ className: 'custom-marker-app', html: '📍' }) });
            }

                        
            function displayShopDetails(shopId, shopName) {
                fetch(`/api/shops/${shopId}/posts`)
                    .then(response => response.json())
                    .then(posts => {
                        // ▼▼▼ contentを生成する部分を以下のように書き換える ▼▼▼
                        let content = `<h2>${shopName}</h2>`;
                        if (posts.length > 0) {
                            // index.htmlと同じクラス名 post-grid を使用
                            content += '<div class="post-grid">';
                            posts.forEach(post => {
                                // index.htmlと全く同じHTML構造を生成
                                content += `
                                    <div class="post-card">
                                        <img src="/static/uploads/${post.image_filename}" alt="User post">
                                        <div class="post-info">
                                            <p class="post-body">${post.body || ''}</p>
                                            <p class="post-meta">
                                                Posted by ${post.author_username}
                                            </p>
                                        </div>
                                    </div>
                                `;
                            });
                            content += '</div>';
                        } else {
                            content += '<p>まだ投稿がありません。</p>';
                        }
                        detailsContainer.innerHTML = content;
                    });
            }


            window.searchMap = function() {
                // レイヤーをクリア
                ourShopsLayer.clearLayers();
                osmShopsLayer.clearLayers();
                
                const bounds = map.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const keyword = document.getElementById('searchInput').value;
                const ourShopOsmIds = new Set();

                // 1. 自前のDBからお店を取得
                fetch('/api/shops')
                    .then(response => response.json())
                    .then(data => {
                        data.features.forEach(feature => {
                            ourShopOsmIds.add(feature.properties.osm_id); // osm_idをセットに保存
                        });
                        ourShopsLayer.addData(data);
                    })
                    .then(() => {
                        // 2. Overpass APIからお店を取得
                        fetch(`/api/osm_search?keyword=${keyword}&bbox=${bbox}`)
                            .then(response => response.json())
                            .then(data => {
                                // 自前DBにないお店だけをフィルタリング
                                const filteredFeatures = data.features.filter(
                                    feature => !ourShopOsmIds.has(feature.properties.osm_id)
                                );
                                osmShopsLayer.addData({ type: "FeatureCollection", features: filteredFeatures });
                            });
                    });
            }

            // --- イベントリスナー ---
            ourShopsLayer.on('click', e => displayShopDetails(e.layer.feature.properties.id, e.layer.feature.properties.name));
            osmShopsLayer.on('click', e => {
                // OSMデータピンのクリックイベント（将来的に投稿を促す機能などを追加）
                const shopName = e.layer.feature.properties.name || '名前不明';
                detailsContainer.innerHTML = `<h2>${shopName}</h2><p>まだこのお店の投稿はありません。最初の投稿者になりましょう！</p><a href="/create_post?shop_name=${shopName}">投稿する</a>`;
            });

            // --- 初期表示 ---
            searchMap();
            map.on('moveend', searchMap);
        });
    </script>
{% endblock %}