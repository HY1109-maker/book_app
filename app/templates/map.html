{% extends "base.html" %}

{% block content %}
    <div id="map-container">
        <div id="map"></div>
        <div id="search-box-container">
            <input type="text" id="searchInput" value="カフェ" placeholder="場所やジャンルを検索...">
            <button onclick="searchShops()">検索</button>
        </div>
    </div>
{% endblock %}

{% block head_extra %}
    <script>
        // DOMが読み込まれた後にスクリプトを実行
        document.addEventListener('DOMContentLoaded', function () {
            
            // 地図の初期化 (京都市役所前あたり)
            const map = L.map('map').setView([35.0116, 135.7681], 14);

            // 背景タイル
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            let geoJsonLayer; // マーカーレイヤーを保持する変数

            // グローバルスコープに関数を公開
            window.searchShops = function() {
                const keyword = document.getElementById('searchInput').value;
                const bounds = map.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;

                // FlaskのAPIエンドポイントを呼び出す
                fetch(`/search_shops?keyword=${keyword}&bbox=${bbox}`)
                    .then(response => response.json())
                    .then(data => {
                        // 既存のマーカーがあれば削除
                        if (geoJsonLayer) {
                            map.removeLayer(geoJsonLayer);
                        }

                        // GeoJSONデータからマーカーを作成して地図に追加
                        geoJsonLayer = L.geoJSON(data, {
                            onEachFeature: function (feature, layer) {
                                // ポップアップに店の名前を表示
                                const shopName = feature.properties.name || '名前なし';
                                layer.bindPopup(shopName);
                            }
                        }).addTo(map);
                    })
                    .catch(error => console.error('Error:', error));
            }

            // 初回読み込み時に一度検索を実行
            searchShops();

            // 地図の移動が終わったら再検索
            map.on('moveend', searchShops);
        });
    </script>
{% endblock %}