{% extends "base.html" %}

{% block content %}
    <div id="map-container">
        <div id="map"></div>
        <div id="search-box-container">
            <input type="text" id="searchInput" value="ã‚«ãƒ•ã‚§" placeholder="å ´æ‰€ã‚„ã‚¸ãƒ£ãƒ³ãƒ«ã‚’æ¤œç´¢...">
            <button onclick="searchMap()">åœ°å›³ã‚’æ¤œç´¢</button>
        </div>
        <div id="shop-details-container">
             <p class="placeholder-text">ãŠåº—ã®ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æŠ•ç¨¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
    </div>
{% endblock %}

{% block head_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([35.0116, 135.7681], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                // ... attribution ...
            }).addTo(map);

            const detailsContainer = document.getElementById('shop-details-container');
            let ourShopsLayer = L.geoJSON(null, { pointToLayer: createOurShopMarker }).addTo(map);
            let osmShopsLayer = L.geoJSON().addTo(map);

            // --- é–¢æ•°å®šç¾© ---
            function createOurShopMarker(feature, latlng) {
                // è‡ªå‰ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ (ä¾‹: è‰²ã‚’å¤‰ãˆã‚‹)
                return L.marker(latlng, { icon: L.divIcon({ className: 'custom-marker-app', html: 'ğŸ“' }) });
            }

                        
            function displayShopDetails(shopId, shopName) {
                fetch(`/api/shops/${shopId}/posts`)
                    .then(response => response.json())
                    .then(posts => {
                        // â–¼â–¼â–¼ contentã‚’ç”Ÿæˆã™ã‚‹éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹ â–¼â–¼â–¼
                        let content = `<h2>${shopName}</h2>`;
                        if (posts.length > 0) {
                            // index.htmlã¨åŒã˜ã‚¯ãƒ©ã‚¹å post-grid ã‚’ä½¿ç”¨
                            content += '<div class="post-grid">';
                            posts.forEach(post => {
                                // index.htmlã¨å…¨ãåŒã˜HTMLæ§‹é€ ã‚’ç”Ÿæˆ
                                content += `
                                    <div class="post-card">
                                        <img src="/static/uploads/${post.image_filename}" alt="User post">
                                        <div class="post-info">
                                            <p class="post-body">${post.body || ''}</p>
                                            <p class="post-meta">
                                                Posted by ${post.author_username}
                                            </p>
                                        </div>
                                    </div>
                                `;
                            });
                            content += '</div>';
                        } else {
                            content += '<p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        }
                        detailsContainer.innerHTML = content;
                    });
            }


            window.searchMap = function() {
                // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                ourShopsLayer.clearLayers();
                osmShopsLayer.clearLayers();
                
                const bounds = map.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const keyword = document.getElementById('searchInput').value;
                const ourShopOsmIds = new Set();

                // 1. è‡ªå‰ã®DBã‹ã‚‰ãŠåº—ã‚’å–å¾—
                fetch('/api/shops')
                    .then(response => response.json())
                    .then(data => {
                        data.features.forEach(feature => {
                            ourShopOsmIds.add(feature.properties.osm_id); // osm_idã‚’ã‚»ãƒƒãƒˆã«ä¿å­˜
                        });
                        ourShopsLayer.addData(data);
                    })
                    .then(() => {
                        // 2. Overpass APIã‹ã‚‰ãŠåº—ã‚’å–å¾—
                        fetch(`/api/osm_search?keyword=${keyword}&bbox=${bbox}`)
                            .then(response => response.json())
                            .then(data => {
                                // è‡ªå‰DBã«ãªã„ãŠåº—ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                                const filteredFeatures = data.features.filter(
                                    feature => !ourShopOsmIds.has(feature.properties.osm_id)
                                );
                                osmShopsLayer.addData({ type: "FeatureCollection", features: filteredFeatures });
                            });
                    });
            }

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            ourShopsLayer.on('click', e => displayShopDetails(e.layer.feature.properties.id, e.layer.feature.properties.name));
            osmShopsLayer.on('click', e => {
                // OSMãƒ‡ãƒ¼ã‚¿ãƒ”ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå°†æ¥çš„ã«æŠ•ç¨¿ã‚’ä¿ƒã™æ©Ÿèƒ½ãªã©ã‚’è¿½åŠ ï¼‰
                const shopName = e.layer.feature.properties.name || 'åå‰ä¸æ˜';
                detailsContainer.innerHTML = `<h2>${shopName}</h2><p>ã¾ã ã“ã®ãŠåº—ã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p><a href="/create_post?shop_name=${shopName}">æŠ•ç¨¿ã™ã‚‹</a>`;
            });

            // --- åˆæœŸè¡¨ç¤º ---
            searchMap();
            map.on('moveend', searchMap);
        });
    </script>
{% endblock %}