{% extends "base.html" %}

{% block content %}
    <h1>Timeline</h1>
    <div class="post-grid" id="timeline-grid">
        </div>
    
    <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">
        <p>Loading more posts...</p>
    </div>
    <div id="end-of-timeline" style="text-align: center; padding: 20px; display: none;">
        <p>You've reached the end!</p>
    </div>
{% endblock %}

{% block head_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const timelineGrid = document.getElementById('timeline-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfTimelineMessage = document.getElementById('end-of-timeline');
    
    let currentPage = 1;
    let isLoading = false;
    let hasMorePages = true; // 次のページがあるかを管理するフラグ

    function fetchPosts() {
        if (isLoading || !hasMorePages) return; // 読み込み中 or 最終ページなら何もしない
        isLoading = true;
        loadingIndicator.style.display = 'block';

        fetch(`/api/timeline?page=${currentPage}`)
            .then(response => response.json())
            .then(data => {
                const posts = data.posts;
                posts.forEach(post => {
                    const postCard = `
                        <div class="post-card">
                            <img src="/static/uploads/${post.image_filename}" alt="User post">
                            <div class="post-info">
                                <p class="post-body">${post.body || ''}</p>
                                <p class="post-meta">
                                    Posted by ${post.author_username} at ${post.shop_name}
                                </p>
                            </div>
                        </div>
                    `;
                    timelineGrid.insertAdjacentHTML('beforeend', postCard);
                });

                hasMorePages = data.has_next_page;
                if (!hasMorePages) {
                    endOfTimelineMessage.style.display = 'block'; // 最終ページならメッセージを表示
                }
                currentPage++;
                
                loadingIndicator.style.display = 'none';
                isLoading = false;
            })
            .catch(error => {
                console.error('Error fetching timeline posts:', error);
                loadingIndicator.textContent = 'Failed to load posts.';
                isLoading = false;
            });
    }

    // ▼▼▼ スクロールイベントの監視 ▼▼▼
    window.addEventListener('scroll', () => {
        // (ウィンドウの高さ + スクロール量)が、(ページ全体の高さ - 少しの余白)を超えたら次のページを読み込む
        if ((window.innerHeight + window.scrollY) >= document.documentElement.offsetHeight - 200) {
            fetchPosts();
        }
    });

    // 最初のページを読み込む
    fetchPosts();
});
</script>
{% endblock %}