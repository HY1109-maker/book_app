{% extends "base.html" %}

{% block content %}
    <h1>Timeline</h1>
    <div class="post-grid" id="timeline-grid">
        </div>
    
    <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">
        <p>Loading more posts...</p>
    </div>
    <div id="end-of-timeline" style="text-align: center; padding: 20px; display: none;">
        <p>You've reached the end!</p>
    </div>
{% endblock %}

{% block head_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const timelineGrid = document.getElementById('timeline-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfTimelineMessage = document.getElementById('end-of-timeline');
    
    let currentPage = 1;
    let isLoading = false;
    let hasMorePages = true;

    function fetchPosts() {
        if (isLoading || !hasMorePages) return;
        isLoading = true;
        loadingIndicator.style.display = 'block';

        fetch(`/api/timeline?page=${currentPage}`)
            .then(response => response.json())
            .then(data => {
                const posts = data.posts;
                posts.forEach(post => {
                    const postCard = `
                        <div class="post-card">
                            <img src="/static/uploads/${post.image_filename}" alt="User post">
                            <div class="post-info">
                                <p class="post-body">${post.body || ''}</p>
                                <div class="post-actions">
                                    <div class="like-section">
                                        <span class="like-btn ${post.is_liked_by_user ? 'liked' : ''}" data-post-id="${post.id}">❤️</span>
                                        <span class="likes-count">${post.likes_count}</span>
                                    </div>
                                    <div>
                                        <p class="post-meta">
                                            Posted by ${post.author_username}
                                        </p>
                                        <p class="post-meta">
                                            at ${post.shop_name}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    timelineGrid.insertAdjacentHTML('beforeend', postCard);
                });

                hasMorePages = data.has_next_page;
                if (!hasMorePages) {
                    endOfTimelineMessage.style.display = 'block';
                }
                currentPage++;
                
                loadingIndicator.style.display = 'none';
                isLoading = false;
            })
            .catch(error => {
                console.error('Error fetching timeline posts:', error);
                loadingIndicator.textContent = 'Failed to load posts.';
                isLoading = false;
            });
    }

    // 「いいね！」ボタンのクリック処理 (イベント委譲)
    timelineGrid.addEventListener('click', function(event) {
        const likeBtn = event.target.closest('.like-btn');
        if (!likeBtn) return;

        const postId = likeBtn.dataset.postId;
        const isLiked = likeBtn.classList.contains('liked');
        const apiUrl = isLiked ? `/unlike/${postId}` : `/like/${postId}`;

        fetch(apiUrl, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    likeBtn.classList.toggle('liked');
                    const likesCountSpan = likeBtn.nextElementSibling;
                    if (likesCountSpan) {
                        likesCountSpan.textContent = data.likes_count;
                    }
                }
            })
            .catch(error => console.error('Error liking/unliking post:', error));
    });

    // スクロールイベントの監視
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.documentElement.offsetHeight - 200) {
            fetchPosts();
        }
    });

    // 最初のページを読み込む
    fetchPosts();
});
</script>
{% endblock %}