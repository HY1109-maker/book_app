{% extends "base.html" %}

{% block content %}
    <!-- <h1>Timelinße</h1> -->
    <div class="timeline-tabs">
        <button class="tab-link active" data-filter="all">For You</button>
        <button class="tab-link" data-filter="following">Following</button>
    </div>

    <div class="post-grid" id="timeline-grid"></div>
    
    <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">
        <p>Loading more posts...</p>
    </div>
    <div id="end-of-timeline" style="text-align: center; padding: 20px; display: none;">
        <p>You've reached the end!</p>
    </div>
{% endblock %}

{% block head_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const timelineGrid = document.getElementById('timeline-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfTimelineMessage = document.getElementById('end-of-timeline');
    const tabs = document.querySelectorAll('.timeline-tabs .tab-link');
    
    let currentPage = 1;
    let isLoading = false;
    let hasMorePages = true;
    let currentFilter = 'all';

    function fetchPosts() {
        if (isLoading || !hasMorePages) return;
        isLoading = true;
        loadingIndicator.style.display = 'block';

        fetch(`/api/timeline?page=${currentPage}&filter=${currentFilter}`)
            .then(response => response.json())
            .then(data => {
                const posts = data.posts;
                if (currentPage === 1) { // 最初のページをロードするときは、既存のコンテンツをクリア
                    timelineGrid.innerHTML = '';
                }
                posts.forEach(post => {
                    const postCard = `
                             <div class="post-card">
                                <a href="/post/${post.id}" class="post-card-link">
                                    <img src="/static/uploads/${post.image_filename}" alt="User post">
                                    <div class="post-info"> 
                                        <p class="post-body-overlay">${post.body || ''}</p>
                                        <div class="post-actions-overlay">
                                            <div class="like-section">
                                                <i class="fa-solid fa-heart like-icon ${post.is_liked_by_user ? 'liked' : ''}" data-post-id="${post.id}"></i>
                                                <span class="likes-count">${post.likes_count}</span>
                                            </div>
                                            <div class="comment-section">
                                                <i class="fa-solid fa-comment comment-icon"></i>
                                                <span class="comments-count">${post.comments_count}</span>
                                            </div>
                                        </div>
                                        <p class="post-meta-overlay">
                                            by ${post.author_username} at ${post.shop_name}
                                        </p>
                                    </div>
                                </a>
                            </div>
                    `;
                    timelineGrid.insertAdjacentHTML('beforeend', postCard);
                });

                hasMorePages = data.has_next_page;
                if (!hasMorePages) {
                    endOfTimelineMessage.style.display = 'block';
                }
                currentPage++;
            })
            .catch(error => console.error('Error fetching timeline:', error))
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const newFilter = tab.dataset.filter;
            if (newFilter === currentFilter) return;

            currentFilter = newFilter;
            currentPage = 1;
            hasMorePages = true;
            timelineGrid.innerHTML = '';
            endOfTimelineMessage.style.display = 'none';
            
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            fetchPosts();
        });
    });

    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.documentElement.offsetHeight - 200) {
            fetchPosts();
        }
    });

    fetchPosts();
});
</script>
{% endblock %}